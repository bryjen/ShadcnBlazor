@namespace SampleWasmProject.Components.Core.Dialog.Declarative
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime

@if (Context?.Open == true)
{
    <div class="dialog-overlay"
         data-dialog-overlay="@Context.DialogId"
         data-state="@Context.AnimationState"
         style=""></div>

    <div class="dialog-container dialog-position-center"
         @onclick="OnBackdropClick">
        <div class="dialog-content @Class"
             data-dialog-content="@Context.DialogId"
             data-state="@Context.AnimationState"
             style="@GetMaxWidthStyle()"
             @onclick:stopPropagation
             @attributes="AdditionalAttributes">
            <div class="dialog-body">
                @ChildContent
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public string? Class { get; set; }

    [Parameter]
    public string MaxWidth { get; set; } = "444px";

    [Parameter]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    [CascadingParameter]
    private DeclarativeDialogContext? Context { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Context?.Open != true || Context.DotNetRef == null) return;

        try
        {
            await JSRuntime.InvokeVoidAsync("ShadcnBlazor.Dialog.initialize", Context.DialogId, Context.DotNetRef);
        }
        catch (JSException) { }

        // Yield so browser paints "closed" state before we transition to "open"
        await Task.Delay(50);
        if (Context?.Open == true && !Context.IsClosing && Context.AnimationState == "closed")
        {
            Context.SetAnimationState("open");
            try { await JSRuntime.InvokeVoidAsync("ShadcnBlazor.Dialog.focusFirstInDialog", Context.DialogId); }
            catch (JSException) { }
        }
    }

    private void OnBackdropClick()
    {
        _ = Context?.CloseAsync();
    }

    private string GetMaxWidthStyle() => $"max-width: {MaxWidth};";
}
