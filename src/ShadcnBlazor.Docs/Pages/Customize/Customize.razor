@page "/customize"
@layout NoNavMenuLayout
@using ShadcnBlazor.Docs.Services
@inject ThemeService ThemeService

<div class="p-4 h-full w-full flex gap-4">
    <div class="border-2 border-border flex-1 p-4 rounded-lg">
        <div class="max-w-md rounded-xl border border-border bg-card p-4 space-y-3">
            <div class="text-sm font-medium text-card-foreground">Primary Preview</div>
            <div class="flex items-center gap-3">
                <div class="size-8 rounded-md border border-border" style="background-color: @CurrentPrimaryValue;"></div>
                <div class="text-sm text-muted-foreground">@CurrentPrimaryValue</div>
            </div>
        </div>
    </div>
    <div class="w-[16rem] p-4 rounded-2xl space-y-6">
        <div class="space-y-2">
            <label class="text-xs text-muted-foreground">Theme Preset</label>
            <Select T="ThemePreset"
                    Value="@_selectedThemePreset"
                    ValueChanged="OnThemePresetChanged"
                    Label="Theme Preset"
                    Items="@_themePresetOptions"
                    RenderItem="@RenderThemePresetItem"
                    Placeholder="Select a theme"></Select>
        </div>

        <div class="space-y-2">
            <label class="text-xs text-muted-foreground">Color</label>
            <Select T="ColorOption"
                    Value="@_selectedColor"
                    ValueChanged="OnColorChanged"
                    Label="Color"
                    Items="@_colorOptions"
                    RenderItem="@RenderColorItem"
                    Placeholder="Select a color"></Select>
        </div>
    </div>
</div>

@code {
    public record ColorOption(string Name, string Hex);

    private readonly SelectOption<ColorOption>[] _colorOptions =
    [
        new (new ("Neutral", "#737373"), "Neutral"),
        new (new ("Amber", "#F59E0B"), "Amber"),
        new (new ("Blue", "#3B82F6"), "Blue"),
        new (new ("Cyan", "#06B6D4"), "Cyan"),
        new (new ("Emerald", "#10B981"), "Emerald"),
        new (new ("Fuchsia", "#D946EF"), "Fuchsia"),
        new (new ("Green", "#22C55E"), "Green"),
        new (new ("Indigo", "#6366F1"), "Indigo"),
        new (new ("Lime", "#84CC16"), "Lime"),
        new (new ("Orange", "#F97316"), "Orange"),
        new (new ("Pink", "#EC4899"), "Pink"),
        new (new ("Purple", "#A855F7"), "Purple"),
        new (new ("Red", "#EF4444"), "Red"),
        new (new ("Rose", "#F43F5E"), "Rose"),
        new (new ("Sky", "#0EA5E9"), "Sky"),
        new (new ("Teal", "#14B8A6"), "Teal"),
        new (new ("Violet", "#8B5CF6"), "Violet"),
        new (new ("Yellow", "#EAB308"), "Yellow")
    ];

    private SelectOption<ThemePreset>[] _themePresetOptions = [];
    private ThemePreset? _selectedThemePreset;
    private ColorOption? _selectedColor;

    private string CurrentPrimaryValue => _selectedColor?.Hex ?? ThemeService.CurrentTheme.Primary;

    private RenderFragment<SelectOption<ColorOption>> RenderColorItem => item => __builder =>
    {
        <span>@item.DisplayText</span>
    };

    private RenderFragment<SelectOption<ThemePreset>> RenderThemePresetItem => item => __builder =>
    {
        <div class="flex items-center gap-3 py-1">
            <div class="flex items-center gap-1">
                @foreach (var swatch in item.Value.Swatches)
                {
                    <span class="inline-block size-3 rounded-sm" style="background-color:@swatch"></span>
                }
            </div>
            <span class="font-medium">@item.DisplayText</span>
        </div>
    };

    protected override void OnInitialized()
    {
        _themePresetOptions = ThemeService.Themes
            .Select(preset => new SelectOption<ThemePreset>(preset, preset.Name))
            .ToArray();

        _selectedThemePreset = _themePresetOptions
            .FirstOrDefault(option => option.Value.Name == "Default").Value
            ?? _themePresetOptions.FirstOrDefault().Value;

        SyncSelectedColorFromCurrentTheme();
    }

    private async Task OnThemePresetChanged(ThemePreset? option)
    {
        _selectedThemePreset = option;
        if (_selectedThemePreset is null)
        {
            return;
        }

        await ThemeService.ApplyPresetAsync(_selectedThemePreset);
        SyncSelectedColorFromCurrentTheme();
    }

    private async Task OnColorChanged(ColorOption? option)
    {
        _selectedColor = option;
        if (_selectedColor is null)
        {
            return;
        }

        await ThemeService.SetPrimaryAsync(_selectedColor.Hex);
    }

    private void SyncSelectedColorFromCurrentTheme()
    {
        var currentPrimary = ThemeService.CurrentTheme.Primary;
        _selectedColor = _colorOptions
            .Select(color => color.Value)
            .FirstOrDefault(color => string.Equals(color.Hex, currentPrimary, StringComparison.OrdinalIgnoreCase));
    }
}
