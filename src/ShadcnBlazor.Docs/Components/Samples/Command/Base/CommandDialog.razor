@using Microsoft.JSInterop
@using ShadcnBlazor.Components.Shared.Models.Options
@using ShadcnBlazor.Components.Shared.Services
@typeparam T

<div id="@_elementId" tabindex="-1" class="bg-card w-[30vw] max-h-[50vh] rounded-xl p-1">
    <div class="flex flex-col bg-background/50 w-full rounded-xl h-full max-h-[calc(50vh-0.5rem)]">
        <div id="command-header" class="p-3 w-full shrink-0">
            <CommandSearchInput Placeholder="Search documentation..." @bind-Value="_searchQuery"/>
        </div>
        <div id="@_contentId" class="w-full py-3 overflow-y-auto scrollbar-hide min-h-0">
            @RenderCommandItems.Invoke(GetFilteredCommandItems(), _selectedItem)
        </div>
        <div id="command-footer" class="p-2 w-full bg-card shrink-0 rounded-b-xl">
            <div class="flex items-center gap-2 text-muted-foreground">
                <kbd class="inline-flex items-center justify-center size-5 rounded text-xs bg-background/50">â†µ</kbd>
                <span class="text-xs">Jump to page</span>
            </div>
        </div>
    </div>
</div>

@code {
    [Inject]
    public IKeyInterceptorService KeyInterceptor { get; set; } = null!;
    
    [Inject]
    public IJSRuntime JsRuntime { get; set; } = null!;
    
    [CascadingParameter]
    public IDialogInstance? DialogInstance { get; set; }

    [Parameter]
    public IReadOnlyList<T> CommandItems { get; set; } = [];

    [Parameter]
    public Func<IReadOnlyList<T>, string, IReadOnlyList<T>> Filter { get; set; } = null!;

    [Parameter]
    public Func<IReadOnlyList<T>, int?, RenderFragment> RenderCommandItems { get; set; } = null!;

    // side-effect-ful
    private IReadOnlyList<T> GetFilteredCommandItems()
    {
        var filtered = Filter(CommandItems, _searchQuery);

        if (_selectedItem is null ||
            !filtered.Select(t => t?.GetHashCode()).Where(t => t is not null).Contains(_selectedItem))  // if selected item is not in filtered list, reset selection to first item
        {
            _selectedItem = filtered.FirstOrDefault()?.GetHashCode();
        }
        
        return filtered;
    }
    
    private string _searchQuery = string.Empty;
    
    private IJSObjectReference? _scrollModule;
    
    // current item selection
    private int? _selectedItem;  // hash of item
    private int? _pendingScrollItem;
    
    // key interceptor properties
    private readonly string _elementId = "command-dialog-" + Guid.NewGuid().ToString("N")[..8];
    private readonly string _contentId = "command-dialog-content-" + Guid.NewGuid().ToString("N")[..8];
    private DotNetObjectReference<CommandDialog<T>>? _dotNetRef;
    private KeyInterceptorEventArgs? _lastKeyEvent;
    private bool _keyInterceptorConnected;
    
    private async ValueTask EnsureScrollModuleAsync()
    {
        if (_scrollModule is not null)
            return;

        try
        {
            _scrollModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./Components/Samples/Command/Base/CommandDialog.razor.js");
        }
        catch (JSException)
        {
            _scrollModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "/_content/ShadcnBlazor.Docs/Components/Samples/Command/Base/CommandDialog.razor.js");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _dotNetRef is null)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            var options = new KeyInterceptorOptions(
                new KeyOptions("ArrowUp", subscribeDown: true, preventDown: "key+none", stopDown: "key+none"),
                new KeyOptions("ArrowDown", subscribeDown: true, preventDown: "key+none", stopDown: "key+none"),
                new KeyOptions("Enter", subscribeDown: true, preventDown: "key+none", stopDown: "key+none")
            );
            await KeyInterceptor.ConnectAsync(_elementId, _dotNetRef, options);
            _keyInterceptorConnected = true;
            await EnsureScrollModuleAsync();
        }

        if (_pendingScrollItem is not null)
        {
            await EnsureScrollModuleAsync();
            if (_scrollModule is not null)
            {
                await _scrollModule.InvokeVoidAsync("ensureSelectedVisible", _contentId, _pendingScrollItem.Value.ToString());
                _pendingScrollItem = null;
            }
        }
    }
   
    // key interceptor callback (via js)
    [JSInvokable]
    public async void OnKeyDown(string elementId, KeyInterceptorEventArgs args)
    {
        try
        {
            _lastKeyEvent = args with { Type = "keydown" };
            var filtered = GetFilteredCommandItems();
            var idx = filtered.Select((item, i) => (item, i)).First(x => x.item!.GetHashCode() == _selectedItem).i;
            
            switch (args.Key)
            {
                case "ArrowUp":
                    var prevIdx = (idx - 1 + filtered.Count) % filtered.Count;
                    _selectedItem = filtered[prevIdx]?.GetHashCode();
                    _pendingScrollItem = _selectedItem;
                    break;
                case "ArrowDown":
                    var nextIdx = (idx + 1) % filtered.Count;
                    _selectedItem = filtered[nextIdx]?.GetHashCode();
                    _pendingScrollItem = _selectedItem;
                    break;
                case "Enter":
                    if (_selectedItem is not null)
                        await JsRuntime.InvokeVoidAsync("eval", $"document.getElementById('{_selectedItem}')?.click()");
                    break;
            }
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            // ignored
        }
    }

    [JSInvokable]
    public void OnKeyUp(string elementId, KeyInterceptorEventArgs args)
    { }

    public void Dispose()
    {
        if (_keyInterceptorConnected)
        {
            _ = KeyInterceptor.DisconnectAsync(_elementId);
            _dotNetRef?.Dispose();
        }
        
        if (_scrollModule is not null)
        {
            _ = _scrollModule.DisposeAsync();
            _scrollModule = null;
        }
    }
}
