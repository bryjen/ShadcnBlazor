@using ShadcnBlazor.Components.Shared.Services
@using ShadcnBlazor.Components.Shared.Models.Options
@using Microsoft.JSInterop
@implements IDisposable

<div class="flex flex-col gap-4 max-w-xl">
    <div class="rounded-lg border border-border bg-card p-4">
        <h3 class="text-lg font-semibold mb-2">Keyboard Interceptor Demo</h3>
        <p class="text-sm text-muted-foreground mb-4">
            Click the box below to focus it, then press <kbd class="px-1.5 py-0.5 rounded bg-muted text-xs font-mono">Escape</kbd>,
            <kbd class="px-1.5 py-0.5 rounded bg-muted text-xs font-mono">↑</kbd>,
            <kbd class="px-1.5 py-0.5 rounded bg-muted text-xs font-mono">↓</kbd>,
            <kbd class="px-1.5 py-0.5 rounded bg-muted text-xs font-mono">Enter</kbd>, or
            <kbd class="px-1.5 py-0.5 rounded bg-muted text-xs font-mono">Space</kbd>.
        </p>
        <div id="@_elementId"
             tabindex="-1"
             class="min-h-[120px] rounded-md border border-dashed border-muted-foreground/50 bg-muted/30 p-4 outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
            @if (_lastKeyEvent != null)
            {
                <div class="flex flex-col gap-1 text-sm">
                    <span class="font-medium text-foreground">Last key: <kbd class="px-1.5 py-0.5 rounded bg-background font-mono">@_lastKeyEvent.Key</kbd></span>
                    <span class="text-muted-foreground">Event: @_lastKeyEvent.Type · Modifiers: @FormatModifiers(_lastKeyEvent)</span>
                </div>
            }
            else
            {
                <span class="text-muted-foreground">Click here to focus, then press a key…</span>
            }
        </div>
        @if (_eventLog.Count > 0)
        {
            <div class="mt-3 text-xs text-muted-foreground">
                Recent: @string.Join(" → ", _eventLog.TakeLast(5))
            </div>
        }
    </div>
</div>

@code {
    [Inject]
    private IKeyInterceptorService KeyInterceptor { get; set; } = null!;

    private readonly string _elementId = "key-interceptor-demo-" + Guid.NewGuid().ToString("N")[..8];
    private DotNetObjectReference<KeyInterceptorSample>? _dotNetRef;
    private KeyInterceptorEventArgs? _lastKeyEvent;
    private readonly List<string> _eventLog = [];
    private bool _connected;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            var options = new KeyInterceptorOptions(
                new KeyOptions("Escape", subscribeDown: true, preventDown: "key+none"),
                new KeyOptions("ArrowUp", subscribeDown: true, preventDown: "key+none"),
                new KeyOptions("ArrowDown", subscribeDown: true, preventDown: "key+none"),
                new KeyOptions("Enter", subscribeDown: true, preventDown: "key+none"),
                new KeyOptions(" ", subscribeDown: true, preventDown: "key+none")
            );
            await KeyInterceptor.ConnectAsync(_elementId, _dotNetRef, options);
            _connected = true;
        }
    }

    [JSInvokable]
    public void OnKeyDown(string elementId, KeyInterceptorEventArgs args)
    {
        _lastKeyEvent = args with { Type = "keydown" };
        _eventLog.Add($"↓ {args.Key}");
        InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public void OnKeyUp(string elementId, KeyInterceptorEventArgs args)
    {
        _lastKeyEvent = args with { Type = "keyup" };
        _eventLog.Add($"↑ {args.Key}");
        InvokeAsync(StateHasChanged);
    }

    private static string FormatModifiers(KeyInterceptorEventArgs e)
    {
        var parts = new List<string>();
        if (e.CtrlKey) parts.Add("Ctrl");
        if (e.ShiftKey) parts.Add("Shift");
        if (e.AltKey) parts.Add("Alt");
        if (e.MetaKey) parts.Add("Meta");
        return parts.Count > 0 ? string.Join("+", parts) : "none";
    }

    public void Dispose()
    {
        if (_connected)
        {
            _ = KeyInterceptor.DisconnectAsync(_elementId);
            _dotNetRef?.Dispose();
        }
    }
}
