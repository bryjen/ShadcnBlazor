@using ShadcnBlazor.Docs.Models
@using ShadcnBlazor.Docs.Services

@inject PageTocService TocService

@implements IDisposable
@implements IHandleAfterRender

<PageTitle>@Metadata.Name - ShadcnBlazor</PageTitle>

<div class="flex flex-col gap-8 min-w-0">
    <div class="flex flex-col gap-1">
        <h1 class="text-3xl font-bold">@Metadata.Name</h1>
        <p class="text-base text-muted-foreground">@Metadata.Description</p>
    </div>

    <DocsSection Title="Installation" Id="installation">
        <p class="mb-3">Add the @Metadata.Name component using the CLI:</p>
        <CommandBlock Options="@InstallOptions" DefaultOption="@DefaultInstallOption" />
    </DocsSection>

    @ChildContent

    @if (ApiDoc is not null)
    {
        <DocsSection Title="API Reference" Id="api" AddToToc="false" >
            <div class="w-full h-full max-lg:hidden">
                <ApiReference Doc="@ApiDoc" ShowHeader="false"/>
            </div>
            <div class="w-full h-full block lg:hidden">
                Mobile support for API reference coming soon.
            </div>
        </DocsSection>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public ComponentMetadata Metadata { get; set; } = null!;

    [Parameter, EditorRequired]
    public IReadOnlyDictionary<string, string> InstallOptions { get; set; } = null!;

    [Parameter]
    public string DefaultInstallOption { get; set; } = "shell";

    [Parameter]
    public DocumentedType? ApiDoc { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    protected override void OnParametersSet()
    {
        TocService.Clear();
    }

    Task IHandleAfterRender.OnAfterRenderAsync()
    {
        if (ApiDoc is not null)
            TocService.AddSection("API Reference", "api", 0);
        TocService.Flush();
        return Task.CompletedTask;
    }

    public void Dispose()
    {
        // Don't clear here - the new page's OnParametersSet will clear when it mounts.
        // Clearing here can race with navigation and wipe the new page's TOC.
    }
}
