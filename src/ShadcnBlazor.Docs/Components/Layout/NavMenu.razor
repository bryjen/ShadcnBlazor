@using ShadcnBlazor.Services.Models
@inherits ShadcnComponentBase
@implements IDisposable

<div class="relative pt-20 pb-64 px-12 w-full h-screen-minus-header w-max-full flex flex-col gap-12 overflow-x-hidden overflow-y-scroll scrollbar-hide">

    <div class="w-full flex flex-col gap-1">
        @RenderSectionHeader("Sections", includeTopMargin: false)
        @RenderNavButton("Introduction", "introduction", [])
        @RenderNavButton("Components", "components", [])
        @RenderNavButton("Samples", "samples", [])
        @RenderNavButton("CLI", "cli", [])
        @RenderNavButton("MCP", "mcp", [ComponentDefinition.Tag.Alpha])  @* just reusing component tags *@
    </div>

    <div class="w-full flex flex-col gap-1">
        @RenderSectionHeader("Components", includeTopMargin: false)
        @foreach (var component in ComponentRegistry.Components)
        {
            @RenderNavButton(component.Name, $"components/{component.Slug}", component.Tags)
        }
    </div>

    @{
        var accordionTriggerClass = "text-foreground/70 group-hover:bg-accent group-hover:text-white px-2 py-1 mb-1 " +
                                    "rounded-md transition-colors hover:bg-accent text-sm font-semibold";
    }

    @*
    <div class="w-full flex flex-col gap-1">
        @RenderSectionHeader("Samples", includeTopMargin: false)
        <Accordion DefaultValue="components">
            <AccordionItem Value="components" Class="border-none">
                <AccordionTrigger Class="@accordionTriggerClass">
                    AI Chat
                </AccordionTrigger>
                <AccordionContent>
                    @foreach (var component in ComponentRegistry.Components)
                    {
                        @RenderNavButton(component.Name, $"components/{component.Slug}", component.Tags)
                    }
                </AccordionContent>
            </AccordionItem>
        </Accordion>
    </div>
*@

    <div class="w-full flex flex-col gap-1">
        @RenderSectionHeader("Samples", includeTopMargin: false)
        <Accordion DefaultValue="samples">
            <AccordionItem Value="samples" Class="border-none">
                <AccordionTrigger Class="@accordionTriggerClass">
                    AI Chat
                </AccordionTrigger>
                <AccordionContent>
                    @RenderNavButton("Overview", "samples/ai-chat/overview", [])
                    @RenderNavButton("Components", "samples/ai-chat/components", [])
                    @RenderNavButton("Internals", "samples/ai-chat/internals", [])
                    @RenderNavButton("Extending", "samples/ai-chat/extending", [])
                </AccordionContent>
            </AccordionItem>
        </Accordion>
    </div>
</div>

@code {
    [Inject]
    public required ComponentRegistryService ComponentRegistry { get; set; }

    [Inject]
    public required SampleRegistryService SampleRegistry { get; set; }

    [Inject]
    public required NavigationManager Nav { get; set; }

    private RenderFragment RenderSectionHeader(string text, bool includeTopMargin = true) => __builder =>
    {
        var extraClasses = includeTopMargin ? "mt-8" : "";
        <span class="text-[0.67rem] font-bold uppercase text-foreground/50 px-2 @extraClasses">
            @text
        </span>
    };

    private RenderFragment RenderNavButton(string text, string href, ComponentDefinition.Tag[] tags) => __builder =>
    {
        var active = IsActive(href);
        var spanClass = active
            ? "bg-accent text-white rounded-md px-2 py-1"
            : "text-foreground/70 group-hover:bg-accent group-hover:text-white rounded-md px-2 py-1 transition-colors";
        <a class="w-full inline-flex items-center justify-start h-7 gap-1.5 px-2 font-semibold text-sm antialiased group"
           href="@href"
           @onclick="@(_ => HandleNav(href))"
           @onclick:preventDefault="true">
            <span class="@spanClass">@text</span>
            @foreach(var tag in tags)
            {
#pragma warning disable CS8524 // The switch expression does not handle some values of its input type (it is not exhaustive) involving an unnamed enum value.
                var classes = tag switch {
                    ComponentDefinition.Tag.Alpha => "bg-secondary/25",
                    ComponentDefinition.Tag.Beta => "bg-primary/25",
                };
                <Badge Size="@Size.Sm" Class="@(MergeCss(classes))">
                    @(tag.ToString().ToLower())
                </Badge>
            }
        </a>
    };

    private string CurrentPath => Nav.ToBaseRelativePath(Nav.Uri).TrimStart('/');

    private bool IsActive(string href)
    {
        if (string.IsNullOrEmpty(href))
            return string.IsNullOrEmpty(CurrentPath) || CurrentPath == "/";
        var normalizedHref = href.TrimEnd('/');
        return string.Equals(CurrentPath, normalizedHref, StringComparison.OrdinalIgnoreCase) ||
               CurrentPath.StartsWith(normalizedHref + "/", StringComparison.OrdinalIgnoreCase);
    }

    private void HandleNav(string href) => Nav.NavigateTo(href);

    protected override void OnInitialized()
    {
        Nav.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs _)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }
}
