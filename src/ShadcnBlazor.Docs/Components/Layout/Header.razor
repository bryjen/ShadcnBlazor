@using ShadcnBlazor.Docs.Components.Samples.Command
@using Microsoft.AspNetCore.Components.WebAssembly.Hosting
@using System.Text.Json.Serialization

@implements IAsyncDisposable

<div class="h-full w-full px-6 flex items-center justify-between gap-2">
    @* left side *@
    <div class="h-full">
        <div data-device="desktop" class="max-lg:hidden h-full flex items-center gap-2">
            <a class="inline-flex items-center justify-center h-8 rounded-md gap-1.5 px-2 font-semibold text-sm
              text-foreground/70 antialiased transition-colors hover:bg-accent hover:text-white hover:opacity-100"
               href=""
               aria-label="Home">
                <img src="/ShadcnBlazor/favicon.svg" class="size-5 text-foreground/70" alt="home" />
            </a>

            @RenderNavButton("Docs", "introduction")
            @RenderNavButton("Components", "components")
            @RenderNavButton("Samples", "samples")

            @if (InDev)
            {
                <div class="w-px h-6 bg-border"></div>
                @RenderNavButton("Playground", "playground")
            }
        </div>

        <div data-device="mobile" class="hidden max-lg:flex h-full items-center gap-2">
            <Button Variant="@Variant.Ghost" Size="@Size.Sm" Class="size-8 px-2" OnClick="@OpenMobileMenu">
                <LuMenu class="size-5" />
            </Button>
        </div>
    </div>

    <div data-device="desktop" class="h-full flex items-center gap-2">
        <CommandInline @ref="@_command">
            <Button id="global-command-search-trigger" Class="max-lg:hidden" Size="@Size.Lg" Variant="@Variant.Outline">
                <div class="flex gap-2 pr-3 items-center">
                    <LuSearch class="size-4"/>
                    <span class="text-sm">
                        Search Documentation ...
                    </span>
                </div>
            </Button>
        </CommandInline>

        <div class="w-px h-4 bg-border"></div>

        <Tooltip>
            <Anchor>
                <a class="inline-flex items-center justify-center h-8 rounded-md gap-1.5 px-2 font-semibold text-sm group
                          text-foreground/70 antialiased transition-colors hover:bg-accent hover:text-white hover:opacity-100"
                   href="https://github.com/bryjen/ShadcnBlazor">
                    <LuGithub class="size-4"/>
                    @if (_stars.HasValue)
                    {
                        <span class="text-muted-foreground text-xs transition-all duration-300 group-hover:text-foreground">@FormatStars(_stars.Value)</span>
                    }
                </a>
            </Anchor>
            <ChildContent>
                <span class="block font-bold text-xs text-center text-foreground">GitHub Repo</span>
            </ChildContent>
        </Tooltip>

        <div class="w-px h-4 bg-border"></div>

        <Tooltip>
            <Anchor>
                <button class="inline-flex items-center justify-center h-8 rounded-md gap-1.5 px-2 font-semibold text-sm group
                               text-foreground/70 antialiased transition-colors hover:bg-accent hover:text-white hover:opacity-100"
                        type="button"
                        aria-label="Toggle Dark/Light Mode"
                        @onclick="ToggleThemeAsync">
                    <LuSun class="size-4"/>
                </button>
            </Anchor>
            <ChildContent>
                <span class="block font-bold text-xs text-center text-foreground">Toggle Dark/Light Mode</span>
            </ChildContent>
        </Tooltip>

        <div class="w-px h-4 bg-border"></div>

        <Button Size="@Size.Lg" Variant="@Variant.Default" OnClick="@(_ => NavigationManager.NavigateTo("customize"))">
            <div class="flex gap-2 items-center">
                <LuPalette class="w-fit left-2 size-4"/>
                <span class="max-lg:hidden flex-1 text-sm">
                    Customize Theme
                </span>
                <span class="hidden max-lg:block flex-1 text-sm">
                    New
                </span>
            </div>
        </Button>
    </div>
</div>

@code {
    private CommandInline _command = default!;
    private IJSObjectReference? _themeModule;

    [Inject]
    public required ISheetService SheetService { get; set; }

    [Inject]
    public HttpClient Http { get; set; } = null!;

    [Inject]
    public IJSRuntime JsRuntime { get; set; } = null!;

    [Inject]
    public NavigationManager NavigationManager { get; set; } = null!;

    [Inject]
    public IWebAssemblyHostEnvironment HostEnvironment { get; set; } = null!;

    private void OpenMobileMenu()
    {
        SheetService.Show<MobileNavSheet>();
    }

    @*TODO: MERGE THIS WITH THAT IN MAVMENU*@
    private RenderFragment RenderNavButton(string text, string href) => __builder =>
    {
        <a class="inline-flex items-center justify-center h-8 rounded-md gap-1.5 px-3 font-semibold text-sm
          text-foreground/70 antialiased transition-colors hover:bg-accent hover:text-white hover:opacity-100"
           href="@href">
            @text
        </a>
    };


    private int? _stars;

    protected override async Task OnInitializedAsync()
    {
        if (HostEnvironment.IsEnvironment("Prerendering"))
            return;

        var repo = await Http.GetFromJsonAsync<GitHubRepo>("https://api.github.com/repos/bryjen/ShadcnBlazor");
        _stars = repo?.StargazersCount;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        _themeModule = await JsRuntime.InvokeAsync<IJSObjectReference>(
            "import",
            $"{NavigationManager.BaseUri}Components/Layout/Header.razor.js");

        await _themeModule.InvokeVoidAsync("initializeTheme");
    }

    private async Task ToggleThemeAsync()
    {
        if (_themeModule is null)
        {
            return;
        }

        await _themeModule.InvokeVoidAsync("toggleTheme");
    }

    private static string FormatStars(int stars) =>
        stars >= 1000 ? $"{stars / 1000.0:0.#}k" : stars.ToString();

    private record GitHubRepo([property: JsonPropertyName("stargazers_count")] int StargazersCount);


    public async ValueTask DisposeAsync()
    {
        if (_themeModule is null)
        {
            return;
        }

        await _themeModule.DisposeAsync();
        _themeModule = null;
    }

    private bool InDev =>
#if DEBUG
        true;
#else
        false;
#endif
}


