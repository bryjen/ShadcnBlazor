@typeparam T
@using ShadcnBlazor.Components.Popover
@using ShadcnBlazor.Components.Popover.Models
@using ShadcnBlazor.Shared.Enums
@inherits ShadcnComponentBase

<Popover Open="@_open" 
         OpenChanged="@(v => _open = v)" 
         CloseOnOutsideClick="true" 
         AnchorOrigin="PopoverPlacement.BottomLeft" 
         TransformOrigin="PopoverPlacement.TopLeft" 
         WidthMode="@(PopoverFitContent ? PopoverWidthMode.Adaptive : PopoverWidthMode.Relative)"
         AnchorClass="min-w-full max-w-full w-full">
    <Anchor>
        <button type="button"
                role="combobox"
                aria-expanded="@_open"
                aria-haspopup="listbox"
                aria-disabled="@Disabled"
                data-size="@Size.ToString().ToLower()"
                class="@GetTriggerClass()"
                disabled="@Disabled"
                @onclick="ToggleOpen"
                @attributes="AdditionalAttributes">
            <span class="truncate">@GetDisplayText()</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="@(_open ? "rotate-180" : "") transition-transform duration-200">
                <path d="m6 9 6 6 6-6"/>
            </svg>
        </button>
    </Anchor>
    <ChildContent>
        <div class="@GetContentClass() rounded-lg border border-input bg-popover text-popover-foreground shadow-lg p-1 min-w-[8rem]">
            @if (!string.IsNullOrEmpty(Label))
            {
                <div class="px-2 py-1.5 text-xs font-medium text-muted-foreground">@Label</div>
            }
            <div class="max-h-[var(--radix-select-content-available-height)] overflow-y-auto overflow-x-hidden" role="listbox">
                @foreach (var item in Items)
                {
                    <button type="button"
                            role="option"
                            aria-selected="@IsSelected(item.Value)"
                            class="@(IsSelected(item.Value) ? "bg-primary text-primary-foreground" : "hover:bg-accent hover:text-accent-foreground") flex w-full cursor-pointer items-center gap-2 rounded-md px-2 py-1.5 text-sm outline-none transition-colors"
                            @onclick="() => SelectOptionAsync(item)"
                            @onclick:preventDefault="true">
                        @if (IsSelected(item.Value))
                        {
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="size-4 shrink-0">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        }
                        <span class="@(PopoverFitContent ? "whitespace-nowrap" : "truncate")">@item.DisplayText</span>
                    </button>
                }
            </div>
        </div>
    </ChildContent>
</Popover>

@code {
    [Parameter] public string? Label { get; set; }
    [Parameter] public T? Value { get; set; }
    [Parameter] public EventCallback<T?> ValueChanged { get; set; }
    [Parameter, EditorRequired] public required IEnumerable<SelectOption<T>> Items { get; set; }
    [Parameter] public string Placeholder { get; set; } = "Select...";
    [Parameter] public Size Size { get; set; } = Size.Md;
    /// <summary>
    /// When true, the popover expands to fit the width of its option content instead of matching the trigger width.
    /// </summary>
    [Parameter] public bool PopoverFitContent { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public string TriggerClass { get; set; } = string.Empty;

    private bool _open;

    private string GetContentClass()
    {
        return PopoverFitContent
            ? "w-max"
            : "w-[var(--popover-width)]";
    }

    private string GetTriggerClass()
    {
        var baseClasses = "flex w-full items-center justify-between gap-2 rounded-md border border-input bg-input/30 shadow-xs transition-colors hover:bg-input/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0";
        var sizeClasses = Size switch
        {
            Size.Sm => "h-6 px-1.75 py-0.75 text-[0.6rem]",
            Size.Md => "h-7 px-2.5 py-1 text-sm",
            Size.Lg => "h-8 px-2.75 py-1.25 text-base md:text-sm",
            _ => "h-7 px-2.5 py-1 text-sm",
        };
        return MergeCss(baseClasses, sizeClasses, TriggerClass);
    }

    private string GetDisplayText()
    {
        if (Value is null)
            return Placeholder;
        var option = Items.FirstOrDefault(o => EqualityComparer<T>.Default.Equals(o.Value, Value));
        return option.DisplayText;
    }

    private bool IsSelected(T? value)
    {
        if (value is null && Value is null) return true;
        if (value is null || Value is null) return false;
        return EqualityComparer<T>.Default.Equals(value, Value);
    }

    private async Task SelectOptionAsync(SelectOption<T> option)
    {
        Value = option.Value;
        await ValueChanged.InvokeAsync(Value);
        _open = false;
    }

    private void ToggleOpen()
    {
        if (!Disabled)
            _open = !_open;
    }
}
