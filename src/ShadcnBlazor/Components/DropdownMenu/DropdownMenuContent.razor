@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inherits ShadcnComponentBase
@inject IJSRuntime JsRuntime
@implements IAsyncDisposable

@code {
    [CascadingParameter]
    private DropdownMenuContext? Context { get; set; }

    /// <summary>
    /// The menu content.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private readonly string _contentId = $"dropdown-menu-{Guid.NewGuid():N}";
    private bool _wasOpen;
    private bool _returnFocusOnClose = true;
    private IJSObjectReference? _module;

    private RenderFragment ContentFragment => Context is not null
        ? @<CascadingValue TValue="DropdownMenuContext" Value="Context" IsFixed="true">
            <div id="@_contentId" role="menu" tabindex="-1" class="@MergeCss("dropdown-menu-panel", Class)" @attributes="AdditionalAttributes" @onkeydown="HandleKeyDown">
                @ChildContent
            </div>
        </CascadingValue>
        : @<div id="@_contentId" role="menu" tabindex="-1" class="@MergeCss("dropdown-menu-panel", Class)" @attributes="AdditionalAttributes" @onkeydown="HandleKeyDown">@ChildContent</div>;

    protected override void OnInitialized()
    {
        Context?.RegisterContent(ContentFragment);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var isOpen = Context?.Open == true;
        if (isOpen && !_wasOpen)
        {
            await EnsureModuleAsync();
            if (_module is not null)
            {
                await _module.InvokeVoidAsync("focusMenu", _contentId);
            }
        }
        else if (!isOpen && _wasOpen)
        {
            await EnsureModuleAsync();
            if (_module is not null && _returnFocusOnClose && Context is not null)
            {
                await _module.InvokeVoidAsync("focusElement", Context.TriggerId);
            }
            _returnFocusOnClose = true;
        }

        _wasOpen = isOpen;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (Context is null)
            return;

        switch (e.Key)
        {
            case "ArrowDown":
                await EnsureModuleAsync();
                if (_module is not null)
                    await _module.InvokeVoidAsync("moveFocus", _contentId, 1);
                break;
            case "ArrowUp":
                await EnsureModuleAsync();
                if (_module is not null)
                    await _module.InvokeVoidAsync("moveFocus", _contentId, -1);
                break;
            case "Home":
                await EnsureModuleAsync();
                if (_module is not null)
                    await _module.InvokeVoidAsync("focusFirstItem", _contentId);
                break;
            case "End":
                await EnsureModuleAsync();
                if (_module is not null)
                    await _module.InvokeVoidAsync("focusLastItem", _contentId);
                break;
            case "Escape":
                _returnFocusOnClose = true;
                Context.SetOpen?.Invoke(false);
                break;
            case "Tab":
                _returnFocusOnClose = false;
                Context.SetOpen?.Invoke(false);
                break;
        }
    }

    private async Task EnsureModuleAsync()
    {
        if (_module is not null)
            return;

        _module = await JsRuntime.InvokeAsync<IJSObjectReference>(
            "import",
            "/ShadcnBlazor/_content/ShadcnBlazor/Components/DropdownMenu/DropdownMenuContent.razor.js");
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            await _module.DisposeAsync();
            _module = null;
        }
    }
}
