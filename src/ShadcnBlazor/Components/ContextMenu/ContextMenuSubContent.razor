@namespace ShadcnBlazor.Components.ContextMenu
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inherits ShadcnBlazor.Components.Shared.ShadcnComponentBase
@inject IJSRuntime JsRuntime
@implements IAsyncDisposable

@code {
    [CascadingParameter]
    private ContextMenuSubContext? Context { get; set; }

    /// <summary>
    /// The sub-menu content.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private readonly string _contentId = $"context-submenu-{Guid.NewGuid():N}";
    private bool _wasOpen;
    private IJSObjectReference? _module;

    private RenderFragment ContentFragment => Context is not null
        ? @<CascadingValue TValue="ContextMenuSubContext" Value="Context">
            @if (Context!.RootMenuContext is not null)
            {
                <CascadingValue TValue="ContextMenuContext" Value="Context.RootMenuContext" IsFixed="true">
                    <div id="@_contentId"
                         role="menu"
                         tabindex="-1"
                         class="@MergeCss("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md", Class)"
                         @attributes="AdditionalAttributes"
                         @onkeydown="HandleKeyDown">
                        @ChildContent
                    </div>
                </CascadingValue>
            }
            else
            {
                <div id="@_contentId"
                     role="menu"
                     tabindex="-1"
                     class="@MergeCss("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md", Class)"
                     @attributes="AdditionalAttributes"
                     @onkeydown="HandleKeyDown">
                    @ChildContent
                </div>
            }
        </CascadingValue>
        : @<div id="@_contentId"
               role="menu"
               tabindex="-1"
               class="@MergeCss("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md", Class)"
               @attributes="AdditionalAttributes"
               @onkeydown="HandleKeyDown">
            @ChildContent
        </div>;

    protected override void OnInitialized()
    {
        Context?.RegisterContent(ContentFragment);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var isOpen = Context?.Open == true;
        if (isOpen && !_wasOpen)
        {
            await EnsureModuleAsync();
            if (_module is not null)
            {
                await _module.InvokeVoidAsync("focusMenu", _contentId);
            }
        }
        _wasOpen = isOpen;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        switch (e.Key)
        {
            case "ArrowDown":
                await EnsureModuleAsync();
                if (_module is not null)
                    await _module.InvokeVoidAsync("moveFocus", _contentId, 1);
                break;
            case "ArrowUp":
                await EnsureModuleAsync();
                if (_module is not null)
                    await _module.InvokeVoidAsync("moveFocus", _contentId, -1);
                break;
            case "Home":
                await EnsureModuleAsync();
                if (_module is not null)
                    await _module.InvokeVoidAsync("focusFirstItem", _contentId);
                break;
            case "End":
                await EnsureModuleAsync();
                if (_module is not null)
                    await _module.InvokeVoidAsync("focusLastItem", _contentId);
                break;
            case "Escape":
                Context?.SetOpen?.Invoke(false);
                break;
        }
    }

    private async Task EnsureModuleAsync()
    {
        if (_module is not null)
            return;

        _module = await JsRuntime.InvokeAsync<IJSObjectReference>(
            "import",
            "/ShadcnBlazor/_content/ShadcnBlazor/Components/ContextMenu/ContextMenuContent.razor.js");
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            await _module.DisposeAsync();
            _module = null;
        }
    }
}
