@namespace ShadcnBlazor.Components.ContextMenu
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inherits ShadcnBlazor.Components.Shared.ShadcnComponentBase
@inject IJSRuntime JsRuntime
@implements IAsyncDisposable

@if (Context?.Open == true)
{
    <div style="position:fixed; left:@(Context.X.ToString("F0", System.Globalization.CultureInfo.InvariantCulture))px; top:@(Context.Y.ToString("F0", System.Globalization.CultureInfo.InvariantCulture))px; z-index:9999">
        <div id="@_contentId"
             role="menu"
             tabindex="-1"
             data-state="open"
             class="@MergeCss("dropdown-menu-panel context-menu-panel outline-none", Class)"
             @attributes="AdditionalAttributes"
             @onkeydown="HandleKeyDown">
            @ChildContent
        </div>
    </div>
}

@code {
    [CascadingParameter]
    private ContextMenuContext? Context { get; set; }

    /// <summary>The menu items.</summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private readonly string _contentId = $"context-menu-{Guid.NewGuid():N}";
    private bool _wasOpen;
    private IJSObjectReference? _module;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var isOpen = Context?.Open == true;
        if (isOpen && !_wasOpen)
        {
            await EnsureModuleAsync();
            if (_module is not null)
                await _module.InvokeVoidAsync("focusMenu", _contentId);
        }
        _wasOpen = isOpen;
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (Context is null) return;

        switch (e.Key)
        {
            case "ArrowDown":
                await EnsureModuleAsync();
                if (_module is not null) await _module.InvokeVoidAsync("moveFocus", _contentId, 1);
                break;
            case "ArrowUp":
                await EnsureModuleAsync();
                if (_module is not null) await _module.InvokeVoidAsync("moveFocus", _contentId, -1);
                break;
            case "Home":
                await EnsureModuleAsync();
                if (_module is not null) await _module.InvokeVoidAsync("focusFirstItem", _contentId);
                break;
            case "End":
                await EnsureModuleAsync();
                if (_module is not null) await _module.InvokeVoidAsync("focusLastItem", _contentId);
                break;
            case "Escape":
                if (Context.Close is not null) await Context.Close();
                break;
        }
    }

    private async Task EnsureModuleAsync()
    {
        if (_module is not null) return;
        _module = await JsRuntime.InvokeAsync<IJSObjectReference>(
            "import",
            "/ShadcnBlazor/_content/ShadcnBlazor/Components/ContextMenu/ContextMenuContent.razor.js");
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            await _module.DisposeAsync();
            _module = null;
        }
    }
}
