@using ShadcnBlazor.Components.Shared.Services
@inject IDialogJsService DialogJs

@if (Context?.Open == true)
{
    <div class="dialog-overlay"
         data-dialog-overlay="@Context.DialogId"
         data-state="@Context.AnimationState"
         style=""></div>

    <div class="dialog-container dialog-position-center"
         @onclick="OnBackdropClick">
        <div class="@GetContentClass()"
             data-dialog-content="@Context.DialogId"
             data-state="@Context.AnimationState"
             style="@GetMaxWidthStyle()"
             @onclick:stopPropagation
             @attributes="AdditionalAttributes">
            <div class="dialog-body">
                @ChildContent
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public string? Class { get; set; }

    [Parameter]
    public string MaxWidth { get; set; } = "444px";

    [Parameter]
    public bool Unstyled { get; set; }

    [Parameter]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    [CascadingParameter]
    private DeclarativeDialogContext? Context { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Context?.Open != true || Context.DotNetRef == null) return;

        try
        {
            await DialogJs.InitializeAsync(Context.DialogId, Context.DotNetRef!);
        }
        catch (JSException) { }

        // Yield so browser paints "closed" state before we transition to "open"
        await Task.Delay(50);
        if (Context?.Open == true && !Context.IsClosing && Context.AnimationState == "closed")
        {
            Context.SetAnimationState("open");
            try { await DialogJs.FocusFirstInDialogAsync(Context.DialogId); }
            catch (JSException) { }
        }
    }

    private void OnBackdropClick()
    {
        _ = Context?.CloseAsync();
    }

    private string GetMaxWidthStyle() => Unstyled ? string.Empty : $"max-width: {MaxWidth};";

    private string GetContentClass()
    {
        if (Unstyled)
            return string.IsNullOrWhiteSpace(Class) ? "dialog-unstyled" : $"dialog-unstyled {Class}";

        return string.IsNullOrWhiteSpace(Class) ? "dialog-content" : $"dialog-content {Class}";
    }
}
